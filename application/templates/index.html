{% extends 'base.html' %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/crypto-js/crypto-js.js"></script>

<script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkVDYWK6leViH9msDiR2wvVcn6w9ymyyM&loading=async&libraries=visualization&callback=initMap">
</script>

<div id="map"></div>
<script src="{{ url_for('static', filename='js/mqtt_compiled.js') }}"></script>
<!-- <script>
  let map;
  const markers = {};

  function updateMarkers(livestock) {
    livestock.forEach(animal => {
      if (!markers[animal.id]) {
        const marker = new google.maps.Marker({
          position: { lat: animal.lat, lng: animal.lng },
          map: map,
          title: animal.name,
          icon: {
            url: animal.type === "Cow"
              ? "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"
              : "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
          },
        });

        const infoWindow = new google.maps.InfoWindow({
          content: `<h3>${animal.name}</h3><p>Type: ${animal.type}</p><p>Location: (${animal.lat.toFixed(4)}, ${animal.lng.toFixed(4)})</p>`,
        });

        marker.addListener("click", () => {
          infoWindow.open(map, marker);
        });

        markers[animal.id] = { marker, infoWindow };
      } else {
        markers[animal.id].marker.setPosition(new google.maps.LatLng(animal.lat, animal.lng));
        markers[animal.id].infoWindow.setContent(
          `<h3>${animal.name}</h3><p>Type: ${animal.type}</p><p>Location: (${animal.lat.toFixed(4)}, ${animal.lng.toFixed(4)})</p>`
        );
      }
    });
  }

  // Initialize Google Maps
  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: -31.97, lng: 115.81 },
      zoom: 13,
    });
  }

  // Initialize MQTT client only once
  document.addEventListener("DOMContentLoaded", function() {
    initMqtt(updateMarkers);  // Only initialize MQTT once after DOM is ready
  });

  // Ensure initMap is globally accessible for the Google Maps API callback
  window.initMap = initMap;
</script> -->

{% endblock %}
